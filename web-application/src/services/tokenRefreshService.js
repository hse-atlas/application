import { checkAndRefreshTokenIfNeeded } from '../api';
import { message } from 'antd';

// –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
const TOKEN_CHECK_INTERVAL = 60000; // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

class TokenRefreshService {
  constructor() {
    this.intervalId = null;
    this.isActive = false;
    this.showNotifications = false; // –§–ª–∞–≥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
  }

  // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  toggleNotifications(show) {
    this.showNotifications = show;
  }

  // –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
  start() {
    if (this.isActive) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    this._checkTokenWithNotification();

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    this.intervalId = setInterval(() => {
      this._checkTokenWithNotification();
    }, TOKEN_CHECK_INTERVAL);

    this.isActive = true;
    console.log('Token refresh service started');
  }

  // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
  async _checkTokenWithNotification() {
    try {
      const token = localStorage.getItem('access_token');
      if (!token) {
        this._handleSessionExpired();
        return;
      }

      const { exp } = this._decodeToken(token);
      if (!exp) return;

      const currentTime = Math.floor(Date.now() / 1000);
      const expiresIn = exp - currentTime;

      if (expiresIn < 300) { // 5 –º–∏–Ω—É—Ç
        try {
          // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –µ—Å—Ç—å
          if (this._refreshRequest && this._refreshRequest.cancel) {
            this._refreshRequest.cancel('New refresh attempt');
          }

          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –æ—Ç–º–µ–Ω—ã
          const cancelToken = new axios.CancelToken(c => {
            this._refreshRequest = { cancel: c };
          });

          const oldToken = token;
          const success = await checkAndRefreshTokenIfNeeded({ cancelToken });

          if (!success) {
            throw new Error('Token refresh failed');
          }

          const newToken = localStorage.getItem('access_token');
          if (this.showNotifications && oldToken !== newToken) {
            message.info('Session was extended');
          }
        } catch (error) {
          if (axios.isCancel(error)) {
            console.log('Refresh request canceled:', error.message);
          } else {
            console.error('Token refresh error:', error);
            this._handleSessionExpired();
          }
        } finally {
          this._refreshRequest = null;
        }
      }
    } catch (error) {
      console.error('Token check error:', error);
      this._handleSessionExpired();
    }
  }

  _handleSessionExpired() {
    if (this.showNotifications) {
      message.error('Session expired. Please login again.');
    }
    this.stop();
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –æ—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω –∏ —Ç.–¥.
    localStorage.removeItem('access_token');
    window.location.href = '/login';
  }

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
  stop() {
    if (!this.isActive) return;

    clearInterval(this.intervalId);
    this.intervalId = null;
    this.isActive = false;
    console.log('Token refresh service stopped');
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  registerEventListeners() {
    // –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        this.stop();
      } else {
        this.start(); // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –∏ —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
      }
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –æ–Ω–ª–∞–π–Ω
    window.addEventListener('online', () => {
      checkAndRefreshTokenIfNeeded();
    });
  }
}

// –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
const tokenRefreshService = new TokenRefreshService();
tokenRefreshService.registerEventListeners();

// –ü—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
tokenRefreshService.debug = function () {
  this.toggleNotifications(true);
  console.log('%c[Token Service] üîç Debug mode enabled. You will see notifications when tokens are refreshed.',
    'background: #e6f7ff; color: #1890ff; padding: 4px; border-radius: 2px; font-weight: bold;');
};

export default tokenRefreshService;